<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trang chủ - Healthcare System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .navbar {
            background: #3498db;
            padding: 1rem;
        }
        .navbar-brand {
            color: white !important;
            font-weight: bold;
        }
        .nav-link {
            color: white !important;
        }
        .welcome-section {
            padding: 2rem;
            text-align: center;
            background: linear-gradient(120deg, #a1c4fd 0%, #c2e9fb 100%);
            border-radius: 10px;
            margin: 2rem 0;
        }
        .chart-container {
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        .stats-card {
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
            text-align: center;
            margin-bottom: 2rem;
        }
        .stats-card h3 {
            color: #3498db;
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }
        .stats-card p {
            color: #7f8c8d;
            margin: 0;
        }
        .chat-widget {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }
        .chat-button {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: #3498db;
            color: white;
            border: none;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }
        .chat-box {
            position: fixed;
            bottom: 90px;
            right: 20px;
            width: 350px;
            height: 500px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            display: none;
            flex-direction: column;
            overflow: hidden;
            z-index: 1001;
        }
        .chat-header {
            background: #3498db;
            color: white;
            padding: 15px;
            font-weight: bold;
        }
        .chat-messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
        }
        .message {
            margin-bottom: 10px;
            max-width: 80%;
        }
        .user-message {
            background: #e3f2fd;
            padding: 10px;
            border-radius: 10px;
            margin-left: auto;
        }
        .bot-message {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 10px;
        }
        .chat-input {
            padding: 15px;
            border-top: 1px solid #eee;
            display: flex;
            gap: 10px;
        }
        .chat-input input {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .chat-input button {
            padding: 8px 15px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .recommendation-item {
            margin: 5px 0;
            padding: 5px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        .risk-level {
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 0.9em;
            margin-left: 10px;
        }
        .risk-high {
            background: #ffebee;
            color: #c62828;
        }
        .risk-medium {
            background: #fff3e0;
            color: #ef6c00;
        }
        .risk-low {
            background: #e8f5e9;
            color: #2e7d32;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg">
        <div class="container">
            <a class="navbar-brand" href="#">Healthcare System</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/profile" id="profileBtn">Thông tin cá nhân</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="logoutBtn">Đăng xuất</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="welcome-section">
            <h1>Chào mừng đến với Healthcare System</h1>
            <p>Hệ thống quản lý y tế thông minh</p>
        </div>

        <div class="row">
            <div class="col-md-3">
                <div class="stats-card">
                    <h3>1,234</h3>
                    <p>Bệnh nhân</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <h3>56</h3>
                    <p>Bác sĩ</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <h3>89</h3>
                    <p>Y tá</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <h3>45</h3>
                    <p>Phòng khám</p>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="chart-container">
                    <canvas id="patientChart"></canvas>
                </div>
            </div>
            <div class="col-md-6">
                <div class="chart-container">
                    <canvas id="departmentChart"></canvas>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-8">
                <div class="chart-container">
                    <canvas id="revenueChart"></canvas>
                </div>
            </div>
            <div class="col-md-4">
                <div class="chart-container">
                    <canvas id="genderChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="chat-widget">
        <button class="chat-button" id="chatButton">
            <i class="bi bi-chat-dots"></i>
        </button>
        <div class="chat-box" id="chatBox">
            <div class="chat-header">
                Chatbot Tư vấn Sức khỏe
            </div>
            <div class="chat-messages" id="chatMessages">
                <div class="message bot-message">
                    Xin chào! Tôi là chatbot tư vấn sức khỏe. Bạn có thể hỏi tôi về các vấn đề sức khỏe của bạn.
                </div>
            </div>
            <div class="chat-input">
                <input type="text" id="messageInput" placeholder="Nhập tin nhắn của bạn...">
                <button id="sendButton">Gửi</button>
            </div>
        </div>
    </div>

    <script>
        // Kiểm tra đăng nhập
        const user = JSON.parse(localStorage.getItem('user'));
        const token = localStorage.getItem('access_token');
        const refreshToken = localStorage.getItem('refresh_token');
        
        if (!user || !token) {
            window.location.href = '/login';
        }

        // Hàm refresh token
        async function refreshAccessToken() {
            try {
                const response = await fetch('http://localhost:8080/api/users/token/refresh/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        refresh: refreshToken
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    localStorage.setItem('access_token', data.access);
                    return data.access;
                } else {
                    throw new Error('Không thể refresh token');
                }
            } catch (error) {
                console.error('Lỗi refresh token:', error);
                localStorage.removeItem('access_token');
                localStorage.removeItem('refresh_token');
                localStorage.removeItem('user');
                window.location.href = '/login';
                return null;
            }
        }

        // Hàm kiểm tra quyền
        function checkPermission(allowedRoles) {
            const user = JSON.parse(localStorage.getItem('user'));
            if (!user || !user.role) return false;
            return allowedRoles.includes(user.role);
        }

        // Hàm cập nhật giao diện dựa trên role
        function updateUI(userData) {
            const roleBasedMenus = {
                'PATIENT': [
                    { name: 'Hồ sơ bệnh án', url: '/medical-records' },
                    { name: 'Đặt lịch khám', url: '/doctor-schedule' },
                ],
                'DOCTOR': [
                    { name: 'Quản lý bệnh nhân', url: '/patients' },
                    { name: 'Lịch khám', url: '/doctor-schedule' },
                    // { name: 'Kê đơn thuốc', url: '/prescriptions' }
                ],
                'NURSE': [
                    { name: 'Quản lý bệnh nhân', url: '/patients' },
                    { name: 'Chăm sóc bệnh nhân', url: '/patient-care' },
                    { name: 'Quản lý thuốc', url: '/medications' }
                ],
                'ADMIN': [
                    { name: 'Quản lý bệnh nhân', url: '/patients' },
                    { name: 'Quản lý người dùng', url: '/user-management' },
                    { name: 'Báo cáo', url: '/reports' },
                    { name: 'Cài đặt hệ thống', url: '/settings' }
                ],
                'PHARMACIST': [
                    { name: 'Quản lý thuốc', url: '/pharmacy' },
                    { name: 'Đơn thuốc', url: '/prescriptions' }
                ],
                'INSURANCE': [
                    { name: 'Quản lý bảo hiểm', url: '/insurance' },
                    { name: 'Xác nhận thanh toán', url: '/payments' }
                ],
                'LAB_TECHNICIAN': [
                    { name: 'Xét nghiệm', url: '/lab-tests' },
                    { name: 'Kết quả xét nghiệm', url: '/test-results' }
                ]
            };

            // Thêm menu dựa trên role
            const navbarNav = document.getElementById('navbarNav').querySelector('.navbar-nav');
            const currentRole = userData.role;
            
            if (roleBasedMenus[currentRole]) {
                // Xóa các menu cũ (nếu có)
                const existingMenus = navbarNav.querySelectorAll('.role-menu');
                existingMenus.forEach(menu => menu.remove());

                // Thêm menu mới
                roleBasedMenus[currentRole].forEach(menu => {
                    const li = document.createElement('li');
                    li.className = 'nav-item role-menu';
                    li.innerHTML = `<a class="nav-link" href="${menu.url}">${menu.name}</a>`;
                    navbarNav.insertBefore(li, navbarNav.lastElementChild);
                });
            }
        }

        // Lấy thông tin người dùng
        async function fetchUserInfo() {
            try {
                let currentToken = token;
                let response = await fetch('http://localhost:8080/api/users/me/', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${currentToken}`
                    }
                });

                // Nếu token hết hạn, thử refresh token
                if (response.status === 401) {
                    const newToken = await refreshAccessToken();
                    if (newToken) {
                        currentToken = newToken;
                        response = await fetch('http://localhost:8080/api/users/me/', {
                            method: 'GET',
                            headers: {
                                'Authorization': `Bearer ${currentToken}`
                            }
                        });
                    }
                }

                if (response.ok) {
                    const data = await response.json();
                    // Lưu thông tin người dùng vào localStorage, bao gồm cả role
                    localStorage.setItem('user', JSON.stringify({
                        ...data,
                        role: data.role
                    }));
                    
                    // Cập nhật giao diện dựa trên role
                    updateUI(data);
                } else {
                    alert('Không thể lấy thông tin người dùng. Vui lòng thử lại sau.');
                }
            } catch (error) {
                console.error('Lỗi:', error);
                alert('Có lỗi xảy ra khi lấy thông tin người dùng.');
            }
        }

        // Xử lý đăng xuất
        document.getElementById('logoutBtn').addEventListener('click', (e) => {
            e.preventDefault();
            localStorage.removeItem('access_token');
            localStorage.removeItem('refresh_token');
            localStorage.removeItem('user');
            window.location.href = '/login';
        });

        // Gọi hàm lấy thông tin khi trang được tải
        fetchUserInfo();

        // Biểu đồ số lượng bệnh nhân theo tháng
        new Chart(document.getElementById('patientChart'), {
            type: 'line',
            data: {
                labels: ['T1', 'T2', 'T3', 'T4', 'T5', 'T6'],
                datasets: [{
                    label: 'Số lượng bệnh nhân',
                    data: [65, 59, 80, 81, 56, 55],
                    borderColor: '#3498db',
                    tension: 0.4,
                    fill: true,
                    backgroundColor: 'rgba(52, 152, 219, 0.1)'
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'Thống kê bệnh nhân theo tháng'
                    }
                }
            }
        });

        // Biểu đồ phân bố khoa phòng
        new Chart(document.getElementById('departmentChart'), {
            type: 'doughnut',
            data: {
                labels: ['Nội khoa', 'Ngoại khoa', 'Sản phụ khoa', 'Nhi khoa', 'Cấp cứu'],
                datasets: [{
                    data: [30, 25, 20, 15, 10],
                    backgroundColor: [
                        '#3498db',
                        '#2ecc71',
                        '#e74c3c',
                        '#f1c40f',
                        '#9b59b6'
                    ]
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'Phân bố bệnh nhân theo khoa'
                    }
                }
            }
        });

        // Biểu đồ doanh thu
        new Chart(document.getElementById('revenueChart'), {
            type: 'bar',
            data: {
                labels: ['T1', 'T2', 'T3', 'T4', 'T5', 'T6'],
                datasets: [{
                    label: 'Doanh thu (triệu VND)',
                    data: [120, 190, 300, 250, 200, 280],
                    backgroundColor: '#3498db'
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'Doanh thu theo tháng'
                    }
                }
            }
        });

        // Biểu đồ giới tính
        new Chart(document.getElementById('genderChart'), {
            type: 'pie',
            data: {
                labels: ['Nam', 'Nữ'],
                datasets: [{
                    data: [45, 55],
                    backgroundColor: [
                        '#3498db',
                        '#e74c3c'
                    ]
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'Tỷ lệ giới tính'
                    }
                }
            }
        });

        // Xử lý chatbot
        const chatButton = document.getElementById('chatButton');
        const chatBox = document.getElementById('chatBox');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const chatMessages = document.getElementById('chatMessages');

        // Mở/đóng chat box
        chatButton.addEventListener('click', () => {
            if (chatBox.style.display === 'none' || chatBox.style.display === '') {
                chatBox.style.display = 'flex';
            } else {
                chatBox.style.display = 'none';
            }
        });

        // Đóng chat box khi click ra ngoài
        document.addEventListener('click', (e) => {
            if (!chatBox.contains(e.target) && !chatButton.contains(e.target)) {
                chatBox.style.display = 'none';
            }
        });

        // Hàm thêm tin nhắn vào chat
        function addMessage(message, isUser = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user-message' : 'bot-message'}`;
            messageDiv.innerHTML = message;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Hàm xử lý phản hồi từ chatbot
        function handleBotResponse(response) {
            let message = response.response;
            
            // Chuyển đổi \n thành <br> để hiển thị xuống dòng đúng cách
            if (message) {
                message = message.replace(/\n/g, '<br>');
            }
            
            // Thêm thông tin về mức độ rủi ro
            if (response.risk_level) {
                const riskClass = `risk-${response.risk_level === 'cao' ? 'high' : response.risk_level === 'trung bình' ? 'medium' : 'low'}`;
                message += `<br><br><span class="risk-level ${riskClass}">Mức độ rủi ro: ${response.risk_level}</span>`;
            }

            // Thêm các khuyến nghị
            if (response.recommendations && response.recommendations.length > 0) {
                message += '<br><br><strong>Khuyến nghị:</strong>';
                response.recommendations.forEach(rec => {
                    message += `<div class="recommendation-item">${rec}</div>`;
                });
            }

            addMessage(message);
        }

        // Hàm gửi tin nhắn
        async function sendMessage() {
            const message = messageInput.value.trim();
            if (!message) return;

            // Hiển thị tin nhắn người dùng
            addMessage(message, true);
            messageInput.value = '';

            try {
                let currentToken = token;
                let response = await fetch('http://localhost:8080/api/chatbot/chat/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentToken}`
                    },
                    body: JSON.stringify({ message })
                });

                if (response.status === 401) {
                    const newToken = await refreshAccessToken();
                    if (newToken) {
                        currentToken = newToken;
                        response = await fetch('http://localhost:8080/api/chatbot/chat/', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${currentToken}`
                            },
                            body: JSON.stringify({ message })
                        });
                    }
                }

                if (response.ok) {
                    const data = await response.json();
                    handleBotResponse(data);
                } else {
                    addMessage('Xin lỗi, có lỗi xảy ra khi xử lý tin nhắn của bạn.');
                }
            } catch (error) {
                console.error('Lỗi:', error);
                addMessage('Xin lỗi, có lỗi xảy ra khi xử lý tin nhắn của bạn.');
            }
        }

        // Xử lý sự kiện gửi tin nhắn
        sendButton.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html> 